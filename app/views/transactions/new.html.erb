<%= stylesheet_link_tag "transactions/new", "data-turbo-track": "reload" %>


<h1>家計簿の入力</h1>

<%= form_with(model: @transaction, local: true) do |form| %>
  <%# エラーメッセージの表示 %>
  <% if @transaction.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(@transaction.errors.count, "error") %> prohibited this transaction from being saved:</h2>
      <ul>
        <% @transaction.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>
<%# Stimulusコントローラを接続し、data-actionで変更を検知する %>
<%= form_with(model: @transaction, local: true, data: { controller: "form-toggle", action: "change->form-toggle#toggle" }) do |form| %>
  <%# エラーメッセージを共通パーシャルで表示 %>
  <%= render 'shared/error_messages', model: form.object %>

  <div class="field">
    <%= form.label :transaction_type, '区分' %>
    <div class="radio-buttons-container">
      <%= form.radio_button :transaction_type, 'expense', checked: true, id: 'transaction_type_expense' %>
      <%= form.label :transaction_type_expense, '支出', class: 'radio-label' %>
      <%= form.radio_button :transaction_type, 'income', id: 'transaction_type_income' %>
      <%= form.label :transaction_type_income, '収入', class: 'radio-label' %>
      <%# モデルのenumからラジオボタンを動的に生成 %>
      <% Transaction.transaction_types.keys.each do |type| %>
        <%= form.radio_button :transaction_type, type, checked: (type == 'expense') %>
        <%= form.label "transaction_type_#{type}", Transaction.transaction_types_i18n[type], class: 'radio-label' %>
      <% end %>
    </div>
  </div>

  <div class="field">
    <%= form.label :title, 'タイトル' %>
    <%= form.text_field :title, placeholder: '例: スーパーでの買い物' %>
    <%= form.text_field :title, placeholder: '例: スーパーでの買い物', required: true %>
  </div>

  <div class="field">
    <%= form.label :date, '日付' %>
    <%= form.date_field :date %>
    <%# 初期値を今日の日付に設定 %>
    <%= form.date_field :date, value: Date.today %>
  </div>

  <div class="field">
    <%= form.label :price, '金額' %>
    <%= form.number_field :price, placeholder: '例: 1000' %>
    <%= form.number_field :price, placeholder: '例: 1000', required: true %>
  </div>

  <div id="expense_fields">
    <%#
      もしCategoryモデルがあり、@categoriesにカテゴリ一覧がセットされている場合の例です。
      不要な場合や、実装が異なる場合はこの部分を修正・削除してください。
    %>
    <% if @categories.present? %>
      <div class="field">
        <%= form.label :category_id, 'カテゴリ' %>
        <%= form.collection_select :category_id, @categories, :id, :name, { prompt: 'カテゴリを選択' } %>
      </div>
    <% end %>
  <%# Stimulusのターゲットを設定 %>
  <div data-form-toggle-target="toggleable">
    <div class="field">
      <%= form.label :category_id, 'カテゴリ' %>
      <%= form.collection_select :category_id, @categories, :id, :name, { prompt: 'カテゴリを選択' } %>
    </div>

    <div class="field">
      <%= form.label :pay_type, '支払い方法' %>
      <div class="radio-buttons-container">
        <%= form.radio_button :pay_type, 'cash', checked: true %>
        <%= form.label :pay_type_cash, '現金', class: 'radio-label' %>
        <%= form.radio_button :pay_type, 'credit_card' %>
        <%= form.label :pay_type_credit_card, 'クレジットカード', class: 'radio-label' %>
        <% Transaction.pay_types.keys.each do |type| %>
          <%= form.radio_button :pay_type, type, checked: (type == 'cash') %>
          <%= form.label "pay_type_#{type}", Transaction.pay_types_i18n[type], class: 'radio-label' %>
        <% end %>
      </div>
    </div>

    <div class="field">
      <%= form.label :memo, 'メモ' %>
      <%= form.text_field :memo, placeholder: '例: ランチ代' %>
    </div>
  </div>

  <div class="actions">
    <%= form.submit '登録する' %>
  </div>
<% end %>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const expenseFields = document.getElementById('expense_fields');
    const typeRadios = document.querySelectorAll('input[name="transaction[transaction_type]"]');

    function toggleExpenseFields() {
      const selectedKind = document.querySelector('input[name="transaction[transaction_type]"]:checked').value;
      expenseFields.style.display = selectedKind === 'expense' ? 'block' : 'none';
    }

    // 初期表示
    toggleExpenseFields();

    // ラジオボタンが変更されたときに実行
    typeRadios.forEach(radio => radio.addEventListener('change', toggleExpenseFields));
  });
</script>

<%= link_to '一覧に戻る', transactions_path %>